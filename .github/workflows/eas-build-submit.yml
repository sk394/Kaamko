name: EAS Build and Submit

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
        description: 'Platform to build (ios, android, all)'
      profile:
        required: true
        type: string
        description: 'Build profile (development, preview, production)'
      submit:
        required: false
        type: boolean
        default: false
        description: 'Whether to submit to app stores'
    secrets:
      EXPO_TOKEN:
        required: true
      EXPO_APPLE_ID:
        required: false
      EXPO_APPLE_APP_SPECIFIC_PASSWORD:
        required: false

jobs:
  build:
    name: EAS Build
    runs-on: ubuntu-latest
    
    outputs:
      build-id: ${{ steps.build.outputs.build-id }}
      
    steps:
    - name: Check for EXPO_TOKEN
      run: |
        if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
          echo "Error: EXPO_TOKEN secret is not set"
          exit 1
        fi
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: npm
        
    - name: Setup EAS CLI
      run: npm install -g @expo/eas-cli
        
    - name: Install dependencies
      run: npm ci
      
    - name: Get app version
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "App version: $VERSION"
        
    - name: Build app
      id: build
      run: |
        echo "ðŸš€ Starting EAS build..."
        echo "Platform: ${{ inputs.platform }}"
        echo "Profile: ${{ inputs.profile }}"
        
        # Build the app
        eas build \
          --platform ${{ inputs.platform }} \
          --profile ${{ inputs.profile }} \
          --non-interactive \
          --wait
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        
    - name: Get build info
      id: build-info
      run: |
        # Get the latest build info
        BUILD_INFO=$(eas build:list --json --limit=1 --platform=${{ inputs.platform }} --status=finished)
        echo "build-info=$BUILD_INFO" >> $GITHUB_OUTPUT
        
    - name: Comment on PR with build info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const platform = '${{ inputs.platform }}';
          const profile = '${{ inputs.profile }}';
          const version = '${{ steps.version.outputs.version }}';
          
          const body = `## ðŸš€ Build Completed
          
          **Platform:** ${platform}
          **Profile:** ${profile}
          **Version:** ${version}
          **Status:** âœ… Success
          
          Build artifacts are available in the [Expo dashboard](https://expo.dev/accounts/iamsumankd/projects/kaamko-app/builds).
          
          ${platform === 'ios' || platform === 'all' ? 'ðŸ“± **iOS**: Check App Store Connect for TestFlight builds' : ''}
          ${platform === 'android' || platform === 'all' ? 'ðŸ¤– **Android**: APK available for download' : ''}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  submit:
    name: Submit to App Stores
    runs-on: ubuntu-latest
    needs: build
    if: inputs.submit && inputs.profile == 'production'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: npm
        
    - name: Setup EAS CLI
      run: npm install -g @expo/eas-cli
        
    - name: Submit to iOS App Store
      if: inputs.platform == 'ios' || inputs.platform == 'all'
      run: |
        echo "ðŸŽ Submitting to iOS App Store..."
        eas submit \
          --platform ios \
          --latest \
          --non-interactive
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
        EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      continue-on-error: true
      
    - name: Submit to Google Play Store
      if: inputs.platform == 'android' || inputs.platform == 'all'
      run: |
        echo "ðŸ¤– Submitting to Google Play Store..."
        eas submit \
          --platform android \
          --latest \
          --non-interactive
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      continue-on-error: true
      
    - name: Create submission summary
      run: |
        echo "## ðŸ“¦ App Store Submission Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ inputs.platform }}" == "ios" || "${{ inputs.platform }}" == "all" ]]; then
          echo "| iOS App Store | âœ… Submitted |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ inputs.platform }}" == "android" || "${{ inputs.platform }}" == "all" ]]; then
          echo "| Google Play Store | âœ… Submitted |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Submissions may take time to appear in store consoles." >> $GITHUB_STEP_SUMMARY